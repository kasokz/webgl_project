var app=function(){"use strict";function t(){}const e=t=>t;function i(t){return t()}function r(){return Object.create(null)}function n(t){t.forEach(i)}function o(t){return"function"==typeof t}function s(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function a(t,e){const i=t.subscribe(e);return i.unsubscribe?()=>i.unsubscribe():i}function c(t){let e;return a(t,t=>e=t)(),e}function l(t,e,i){t.$$.on_destroy.push(a(e,i))}const h="undefined"!=typeof window;let d=h?()=>window.performance.now():()=>Date.now(),u=h?t=>requestAnimationFrame(t):t;const g=new Set;let p,m=!1;function f(){g.forEach(t=>{t[0](d())||(g.delete(t),t[1]())}),m=g.size>0,m&&u(f)}function x(t,e){t.appendChild(e)}function v(t,e,i){t.insertBefore(e,i||null)}function y(t){t.parentNode.removeChild(t)}function w(t,e){for(let i=0;i<t.length;i+=1)t[i]&&t[i].d(e)}function _(t){return document.createElement(t)}function b(t){return document.createTextNode(t)}function N(){return b(" ")}function A(t,e,i,r){return t.addEventListener(e,i,r),()=>t.removeEventListener(e,i,r)}function S(t,e,i){null==i?t.removeAttribute(e):t.setAttribute(e,i)}function V(t,e){e=""+e,t.data!==e&&(t.data=e)}function R(t,e){(null!=e||t.value)&&(t.value=e)}function M(t,e,i){t.classList[i?"add":"remove"](e)}let z,$=0,P={};function E(t,e,i,r,n,o,s,a=0){const c=16.666/r;let l="{\n";for(let t=0;t<=1;t+=c){const r=e+(i-e)*o(t);l+=100*t+`%{${s(r,1-r)}}\n`}const h=l+`100% {${s(i,1-i)}}\n}`,d=`__svelte_${function(t){let e=5381,i=t.length;for(;i--;)e=(e<<5)-e^t.charCodeAt(i);return e>>>0}(h)}_${a}`;if(!P[d]){if(!p){const t=_("style");document.head.appendChild(t),p=t.sheet}P[d]=!0,p.insertRule(`@keyframes ${d} ${h}`,p.cssRules.length)}const u=t.style.animation||"";return t.style.animation=`${u?u+", ":""}${d} ${r}ms linear ${n}ms 1 both`,$+=1,d}function T(t,e){t.style.animation=(t.style.animation||"").split(", ").filter(e?t=>t.indexOf(e)<0:t=>-1===t.indexOf("__svelte")).join(", "),e&&!--$&&u(()=>{if($)return;let t=p.cssRules.length;for(;t--;)p.deleteRule(t);P={}})}function C(t){z=t}function F(t){(function(){if(!z)throw new Error("Function called outside component initialization");return z})().$$.on_mount.push(t)}const k=[],B=[],U=[],L=[],D=Promise.resolve();let O,I=!1;function G(t){U.push(t)}function Y(t){L.push(t)}function X(){const t=new Set;do{for(;k.length;){const t=k.shift();C(t),j(t.$$)}for(;B.length;)B.pop()();for(let e=0;e<U.length;e+=1){const i=U[e];t.has(i)||(i(),t.add(i))}U.length=0}while(k.length);for(;L.length;)L.pop()();I=!1}function j(t){t.fragment&&(t.update(t.dirty),n(t.before_update),t.fragment.p(t.dirty,t.ctx),t.dirty=null,t.after_update.forEach(G))}function J(t,e,i){t.dispatchEvent(function(t,e){const i=document.createEvent("CustomEvent");return i.initCustomEvent(t,!1,!1,e),i}(`${e?"intro":"outro"}${i}`))}const H=new Set;let W;function q(){W={r:0,c:[],p:W}}function K(){W.r||n(W.c),W=W.p}function Q(t,e){t&&t.i&&(H.delete(t),t.i(e))}function Z(t,e,i,r){if(t&&t.o){if(H.has(t))return;H.add(t),W.c.push(()=>{H.delete(t),r&&(i&&t.d(1),r())}),t.o(e)}}const tt={duration:0};function et(i,r,s,a){let c=r(i,s),l=a?0:1,h=null,p=null,x=null;function v(){x&&T(i,x)}function y(t,e){const i=t.b-l;return e*=Math.abs(i),{a:l,b:t.b,d:i,duration:e,start:t.start,end:t.start+e,group:t.group}}function w(r){const{delay:o=0,duration:s=300,easing:a=e,tick:w=t,css:_}=c||tt,b={start:d()+o,b:r};r||(b.group=W,W.r+=1),h?p=b:(_&&(v(),x=E(i,l,r,s,o,a,_)),r&&w(0,1),h=y(b,s),G(()=>J(i,r,"start")),function(t){let e;m||(m=!0,u(f)),new Promise(i=>{g.add(e=[t,i])})}(t=>{if(p&&t>p.start&&(h=y(p,s),p=null,J(i,h.b,"start"),_&&(v(),x=E(i,l,h.b,h.duration,0,a,c.css))),h)if(t>=h.end)w(l=h.b,1-l),J(i,h.b,"end"),p||(h.b?v():--h.group.r||n(h.group.c)),h=null;else if(t>=h.start){const e=t-h.start;l=h.a+h.d*a(e/h.duration),w(l,1-l)}return!(!h&&!p)}))}return{run(t){o(c)?(O||(O=Promise.resolve(),O.then(()=>{O=null})),O).then(()=>{c=c(),w(t)}):w(t)},end(){v(),h=p=null}}}const it="undefined"!=typeof window?window:global;function rt(t,e,i){-1!==t.$$.props.indexOf(e)&&(t.$$.bound[e]=i,i(t.$$.ctx[e]))}function nt(t,e,r){const{fragment:s,on_mount:a,on_destroy:c,after_update:l}=t.$$;s.m(e,r),G(()=>{const e=a.map(i).filter(o);c?c.push(...e):n(e),t.$$.on_mount=[]}),l.forEach(G)}function ot(t,e){t.$$.fragment&&(n(t.$$.on_destroy),t.$$.fragment.d(e),t.$$.on_destroy=t.$$.fragment=null,t.$$.ctx={})}function st(t,e){t.$$.dirty||(k.push(t),I||(I=!0,D.then(X)),t.$$.dirty=r()),t.$$.dirty[e]=!0}function at(e,i,o,s,a,c){const l=z;C(e);const h=i.props||{},d=e.$$={fragment:null,ctx:null,props:c,update:t,not_equal:a,bound:r(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(l?l.$$.context:[]),callbacks:r(),dirty:null};let u=!1;d.ctx=o?o(e,h,(t,i)=>{d.ctx&&a(d.ctx[t],d.ctx[t]=i)&&(d.bound[t]&&d.bound[t](i),u&&st(e,t))}):h,d.update(),u=!0,n(d.before_update),d.fragment=s(d.ctx),i.target&&(i.hydrate?d.fragment.l(function(t){return Array.from(t.childNodes)}(i.target)):d.fragment.c(),i.intro&&Q(e.$$.fragment),nt(e,i.target,i.anchor),X()),C(l)}class SvelteComponent{$destroy(){ot(this,1),this.$destroy=t}$on(t,e){const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(e),()=>{const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}$set(){}}const ct=[];function lt(e,i=t){let r;const n=[];function o(t){if(s(e,t)&&(e=t,r)){const t=!ct.length;for(let t=0;t<n.length;t+=1){const i=n[t];i[1](),ct.push(i,e)}if(t){for(let t=0;t<ct.length;t+=2)ct[t][0](ct[t+1]);ct.length=0}}}return{set:o,update:function(t){o(t(e))},subscribe:function(s,a=t){const c=[s,a];return n.push(c),1===n.length&&(r=i(o)||t),s(e),()=>{const t=n.indexOf(c);-1!==t&&n.splice(t,1),0===n.length&&(r(),r=null)}}}}class Vector{constructor(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r}get x(){return this._x}set x(t){this._x=t}get r(){return this.x}set r(t){this.x=t}get y(){return this._y}set y(t){this._y=t}get g(){return this.y}set g(t){this.y=t}get z(){return this._z}set z(t){this._z=t}get b(){return this.z}set b(t){this.z=t}get w(){return this._w}set w(t){this._w=t}get a(){return this.w}set a(t){this.w=t}add(t){return new Vector(this.x+t.x,this.y+t.y,this.z+t.z,1)}sub(t){return new Vector(this.x-t.x,this.y-t.y,this.z-t.z,1)}mul(t){return new Vector(this.x*t,this.y*t,this.z*t,1)}elementMul(t){return new Vector(this.x*t.x,this.y*t.y,this.z*t.z,1)}div(t){return new Vector(this.x/t,this.y/t,this.z/t,1)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new Vector(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x,1)}valueOf(){return[this.x,this.y,this.z,this.w]}normalised(){return this.div(this.length)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}get length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}}class Matrix{constructor(t){this.data=new Float32Array(16);for(let e=0;e<4;e++)for(let i=0;i<4;i++)this.data[4*e+i]=t[4*i+e]}getLeftVector(){return new Vector(this.getVal(0,0),this.getVal(1,0),this.getVal(2,0),0)}getUpVector(){return new Vector(this.getVal(0,1),this.getVal(1,1),this.getVal(2,1),0)}getForwardVector(){return new Vector(this.getVal(0,2),this.getVal(1,2),this.getVal(2,2),0)}getTranslationVector(){return new Vector(this.getVal(0,3),this.getVal(1,3),this.getVal(2,3),0)}getVal(t,e){return this.data[4*e+t]}setVal(t,e,i){this.data[4*e+t]=i}static translation(t){return new Matrix([1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1])}static rotation(t,e){const i=this.identity();return e=e*Math.PI/180,1===t.x?(i.setVal(1,1,Math.cos(e)),i.setVal(2,1,Math.sin(e)),i.setVal(1,2,-Math.sin(e)),i.setVal(2,2,Math.cos(e))):1===t.y?(i.setVal(0,0,Math.cos(e)),i.setVal(0,2,Math.sin(e)),i.setVal(2,0,-Math.sin(e)),i.setVal(2,2,Math.cos(e))):1===t.z&&(i.setVal(0,0,Math.cos(e)),i.setVal(0,1,-Math.sin(e)),i.setVal(1,0,Math.sin(e)),i.setVal(1,1,Math.cos(e))),i}static scaling(t){return new Matrix([t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1])}static lookat(t,e,i){const r=new Vector(e.x-t.x,e.y-t.y,e.z-t.z,1).normalised(),n=r.cross(i).normalised(),o=n.cross(r).normalised();return new Matrix([n.x,n.y,n.z,-n.dot(t),o.x,o.y,o.z,-o.dot(t),-r.x,-r.y,-r.z,r.dot(t),0,0,0,1])}static frustum(t,e,i,r,n,o){return new Matrix([2*n/(e-t),0,(e+t)/(e-t),0,0,2*n/(r-i),(r+i)/(r-i),0,0,0,-(o+n)/(o-n),-2*o*n/(o-n),0,0,-1,0])}static perspective(t,e,i,r){const n=1/Math.tan(t*Math.PI/180/2);return new Matrix([n/e,0,0,0,0,n,0,0,0,0,(r+i)/(i-r),2*r*i/(i-r),0,0,-1,0])}static identity(){return new Matrix([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}mul(t){if(t instanceof Matrix){const e=new Matrix([]);for(let i=0;i<4;i++)for(let r=0;r<4;r++){let n=0;for(let e=0;e<4;e++)n+=this.getVal(i,e)*t.getVal(e,r);e.setVal(i,r,n)}return e}{const e=new Vector(0,0,0,0);return e.x=this.getVal(0,0)*t.x+this.getVal(0,1)*t.y+this.getVal(0,2)*t.z+this.getVal(0,3)*t.w,e.y=this.getVal(1,0)*t.x+this.getVal(1,1)*t.y+this.getVal(1,2)*t.z+this.getVal(1,3)*t.w,e.z=this.getVal(2,0)*t.x+this.getVal(2,1)*t.y+this.getVal(2,2)*t.z+this.getVal(2,3)*t.w,e.w=this.getVal(3,0)*t.x+this.getVal(3,1)*t.y+this.getVal(3,2)*t.z+this.getVal(3,3)*t.w,e}}transpose(){return new Matrix(this.data)}print(){for(let t=0;t<4;t++)console.log("> "+this.getVal(t,0)+"\t"+this.getVal(t,1)+"\t"+this.getVal(t,2)+"\t"+this.getVal(t,3))}invert(){let t,e=this.data,i=new Float32Array(16),r=new Float32Array(12),n=new Float32Array(16);for(let t=0;t<4;t++)n[t]=e[4*t],n[t+4]=e[4*t+1],n[t+8]=e[4*t+2],n[t+12]=e[4*t+3];if(r[0]=n[10]*n[15],r[1]=n[11]*n[14],r[2]=n[9]*n[15],r[3]=n[11]*n[13],r[4]=n[9]*n[14],r[5]=n[10]*n[13],r[6]=n[8]*n[15],r[7]=n[11]*n[12],r[8]=n[8]*n[14],r[9]=n[10]*n[12],r[10]=n[8]*n[13],r[11]=n[9]*n[12],i[0]=r[0]*n[5]+r[3]*n[6]+r[4]*n[7],i[0]-=r[1]*n[5]+r[2]*n[6]+r[5]*n[7],i[1]=r[1]*n[4]+r[6]*n[6]+r[9]*n[7],i[1]-=r[0]*n[4]+r[7]*n[6]+r[8]*n[7],i[2]=r[2]*n[4]+r[7]*n[5]+r[10]*n[7],i[2]-=r[3]*n[4]+r[6]*n[5]+r[11]*n[7],i[3]=r[5]*n[4]+r[8]*n[5]+r[11]*n[6],i[3]-=r[4]*n[4]+r[9]*n[5]+r[10]*n[6],i[4]=r[1]*n[1]+r[2]*n[2]+r[5]*n[3],i[4]-=r[0]*n[1]+r[3]*n[2]+r[4]*n[3],i[5]=r[0]*n[0]+r[7]*n[2]+r[8]*n[3],i[5]-=r[1]*n[0]+r[6]*n[2]+r[9]*n[3],i[6]=r[3]*n[0]+r[6]*n[1]+r[11]*n[3],i[6]-=r[2]*n[0]+r[7]*n[1]+r[10]*n[3],i[7]=r[4]*n[0]+r[9]*n[1]+r[10]*n[2],i[7]-=r[5]*n[0]+r[8]*n[1]+r[11]*n[2],r[0]=n[2]*n[7],r[1]=n[3]*n[6],r[2]=n[1]*n[7],r[3]=n[3]*n[5],r[4]=n[1]*n[6],r[5]=n[2]*n[5],r[6]=n[0]*n[7],r[7]=n[3]*n[4],r[8]=n[0]*n[6],r[9]=n[2]*n[4],r[10]=n[0]*n[5],r[11]=n[1]*n[4],i[8]=r[0]*n[13]+r[3]*n[14]+r[4]*n[15],i[8]-=r[1]*n[13]+r[2]*n[14]+r[5]*n[15],i[9]=r[1]*n[12]+r[6]*n[14]+r[9]*n[15],i[9]-=r[0]*n[12]+r[7]*n[14]+r[8]*n[15],i[10]=r[2]*n[12]+r[7]*n[13]+r[10]*n[15],i[10]-=r[3]*n[12]+r[6]*n[13]+r[11]*n[15],i[11]=r[5]*n[12]+r[8]*n[13]+r[11]*n[14],i[11]-=r[4]*n[12]+r[9]*n[13]+r[10]*n[14],i[12]=r[2]*n[10]+r[5]*n[11]+r[1]*n[9],i[12]-=r[4]*n[11]+r[0]*n[9]+r[3]*n[10],i[13]=r[8]*n[11]+r[0]*n[8]+r[7]*n[10],i[13]-=r[6]*n[10]+r[9]*n[11]+r[1]*n[8],i[14]=r[6]*n[9]+r[11]*n[11]+r[3]*n[8],i[14]-=r[10]*n[11]+r[2]*n[8]+r[7]*n[9],i[15]=r[10]*n[10]+r[4]*n[8]+r[9]*n[9],i[15]-=r[8]*n[9]+r[11]*n[10]+r[5]*n[8],t=n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3],0==t)throw new Error("singular matrix is not invertible");t=1/t;for(let e=0;e<16;e++)i[e]*=t;let o=Matrix.identity();return o.data=i,o}}class Intersection{constructor(t,e,i){this.t=t||1/0,this.point=e,this.normal=i}closerThan(t){return this.t<t.t}}class Node{constructor(t){this.id=t}accept(t){t.visit(this)}}class GroupNode extends Node{constructor(t,e){super(t),this.matrix=e,this.children=new Array}add(t){this.children.push(t)}accept(t){t.visitGroupNode(this)}toJSON(){return{id:this.id,type:this.constructor.name,matrix:this.matrix,children:this.children}}find(t){if(this.id===t)return this;if(0===this.children.length)return null;for(let e of this.children.filter(t=>t instanceof GroupNode)){const i=e.find(t);if(i)return i}return null}static fromJSON(t){const e=new Matrix([]);e.data=t.matrix.data;const i=new GroupNode(t.id,e);return i.children=t.children.map(t=>ht[t.type].fromJSON(t)),i}}class SphereNode extends Node{constructor(t,e,i,r,n){super(t),this.center=e,this.radius=i,this.color=r,this.color2=n}toJSON(){return{id:this.id,type:this.constructor.name,center:this.center,radius:this.radius,color:this.color,color2:this.color2}}static fromJSON(t){if(t.color2){const e=new Vector(t.color2._x,t.color2._y,t.color2._z,t.color2._w);return new SphereNode(t.id,new Vector(t.center._x,t.center._y,t.center._z,t.center._w),t.radius,new Vector(t.color._x,t.color._y,t.color._z,t.color._w),e)}return new SphereNode(t.id,new Vector(t.center._x,t.center._y,t.center._z,t.center._w),t.radius,new Vector(t.color._x,t.color._y,t.color._z,t.color._w))}}class AABoxNode extends Node{constructor(t,e,i,r){super(t),this.minPoint=e,this.center=i,this.color=r}toJSON(){return{id:this.id,type:this.constructor.name,minPoint:this.minPoint,center:this.center,color:this.color}}static fromJSON(t){const e=new Vector(t.minPoint._x,t.minPoint._y,t.minPoint._z,t.minPoint._w),i=new Vector(t.center._x,t.center._y,t.center._z,t.center._w),r=new Vector(t.color._x,t.color._y,t.color._z,t.color._w);return new AABoxNode(t.id,e,i,r)}}class TextureBoxNode extends Node{constructor(t,e,i,r,n){super(t),this.minPoint=e,this.center=i,this.texture=r,this.normalMap=n}toJSON(){return{id:this.id,type:this.constructor.name,minPoint:this.minPoint,center:this.center,texture:this.texture,normalMap:this.normalMap}}static fromJSON(t){const e=new Vector(t.minPoint._x,t.minPoint._y,t.minPoint._z,t.minPoint._w),i=new Vector(t.center._x,t.center._y,t.center._z,t.center._w);return new TextureBoxNode(t.id,e,i,t.texture,t.normalMap)}}class PyramidNode extends Node{constructor(t,e,i,r,n){super(t),this.minPoint=e,this.center=i,this.height=r,this.color=n}toJSON(){return{id:this.id,type:this.constructor.name,minPoint:this.minPoint,center:this.center,height:this.height,color:this.color}}static fromJSON(t){const e=new Vector(t.minPoint._x,t.minPoint._y,t.minPoint._z,t.minPoint._w),i=new Vector(t.center._x,t.center._y,t.center._z,t.center._w),r=new Vector(t.color._x,t.color._y,t.color._z,t.color._w);return new PyramidNode(t.id,e,i,t.height,r)}}class CameraNode extends Node{constructor(t,e,i,r,n,o,s,a){super(t),this.eye=e,this.center=i,this.up=r,this.fovy=n,this.aspect=o,this.near=s,this.far=a}toJSON(){return{id:this.id,type:this.constructor.name,eye:this.eye,center:this.center,up:this.up,fovy:this.fovy,aspect:this.aspect,near:this.near,far:this.far}}accept(t){t.visitCameraNode(this)}static fromJSON(t){const e=new Vector(t.eye._x,t.eye._y,t.eye._z,t.eye._w),i=new Vector(t.center._x,t.center._y,t.center._z,t.center._w),r=new Vector(t.up._x,t.up._y,t.up._z,t.up._w),n=t.fovy,o=t.aspect,s=t.near,a=t.far;return new CameraNode(t.id,e,i,r,n,o,s,a)}}class LightNode extends Node{constructor(t,e){super(t),this.color=e}toJSON(){return{id:this.id,type:this.constructor.name,color:this.color}}accept(t){t.visitLightNode(this)}static fromJSON(t){const e=new Vector(t.color._x,t.color._y,t.color._z,t.color._w);return new LightNode(t.id,e)}}class MeshNode extends Node{constructor(t,e,i){super(t),this.url=e,this.color=i}toJSON(){return{id:this.id,type:this.constructor.name,url:this.url,color:this.color}}static fromJSON(t){const e=t.url,i=new Vector(t.color._x,t.color._y,t.color._z,t.color._w);return new MeshNode(t.id,e,i)}}const ht={GroupNode:GroupNode,SphereNode:SphereNode,AABoxNode:AABoxNode,TextureBoxNode:TextureBoxNode,PyramidNode:PyramidNode,CameraNode:CameraNode,LightNode:LightNode,MeshNode:MeshNode},dt=(()=>{const{subscribe:t,update:e,set:i}=lt({x:0,y:0});return{subscribe:t,setX:t=>{e(e=>({...e,x:t}))},setY:t=>{e(e=>({...e,y:t}))},reset:()=>i({x:0,y:0})}})(),ut=(()=>{const{subscribe:t,update:e,set:i}=lt({x:0,y:0});return{subscribe:t,addX:t=>{e(e=>({...e,x:e.x+t}))},addY:t=>{e(e=>({...e,y:e.y+t}))},reset:()=>i({x:0,y:0})}})(),gt=(()=>{const{subscribe:t,update:e,set:i}=lt({ambient:.6,diffuse:.6,specular:.8,shininess:10});return{subscribe:t,update:e,set:i,loadIntoShader:e=>{t(t=>{e.trySet(e.getUniformFloat.bind(e),"kA",t.ambient),e.trySet(e.getUniformFloat.bind(e),"kD",t.diffuse),e.trySet(e.getUniformFloat.bind(e),"kS",t.specular),e.trySet(e.getUniformFloat.bind(e),"shininess",t.shininess)})()}}})(),pt=(()=>{const{subscribe:t,update:e}=lt(new Map);return{subscribe:t,keydown:t=>e(e=>(e.set(t,!0),e)),keyup:t=>e(e=>(e.set(t,!1),e))}})(),mt=lt({}),ft=lt({}),xt=lt(!1),vt=(()=>{const{subscribe:t,update:e,set:i}=lt(new GroupNode(Matrix.identity()));return{subscribe:t,set:i,add:t=>e(e=>(e.add(t),e)),remove:t=>e(e=>{const i=[];for(e.children=e.children.filter(e=>e.id!=t),i.push.apply(i,e.children);i.length>0;){const e=i.pop();e instanceof GroupNode&&(e.children=e.children.filter(e=>e.id!=t),i.push.apply(i,e.children))}return e})}})(),yt=(()=>{const{subscribe:t,update:e,set:i}=lt([]);return{subscribe:t,set:i,add:t=>e(e=>[...e,t]),remove:t=>e(e=>e.filter((i,r)=>r!==e.indexOf(t)))}})();function wt(t){const e=t-1;return e*e*e+1}function _t(t,{delay:e=0,duration:i=400,easing:r=wt,x:n=0,y:o=0,opacity:s=0}){const a=getComputedStyle(t),c=+a.opacity,l="none"===a.transform?"":a.transform,h=c*(1-s);return{delay:e,duration:i,easing:r,css:(t,e)=>`\n\t\t\ttransform: ${l} translate(${(1-t)*n}px, ${(1-t)*o}px);\n\t\t\topacity: ${c-h*e}`}}function bt(e){var i,r,o,s,a,c,l=e.node.id+"",h=` (${e.node.constructor.name})`;return{c(){i=_("span"),r=_("strong"),o=b(l),s=N(),a=b(h),S(i,"class","svelte-hv05i3"),M(i,"active",e.$selectedNode===e.node),c=[A(i,"click",e.click),A(i,"mouseenter",e.mouseEnter),A(i,"contextmenu",e.remove)]},m(t,e){v(t,i,e),x(i,r),x(r,o),x(i,s),x(i,a)},p(t,e){t.node&&l!==(l=e.node.id+"")&&V(o,l),t.node&&h!==(h=` (${e.node.constructor.name})`)&&V(a,h),(t.$selectedNode||t.node)&&M(i,"active",e.$selectedNode===e.node)},i:t,o:t,d(t){t&&y(i),n(c)}}}function Nt(t,e,i){let r;l(t,mt,t=>{r=t,i("$selectedNode",r)});let{node:n}=e;return t.$set=t=>{"node"in t&&i("node",n=t.node)},{node:n,click:()=>{mt.set(n)},mouseEnter:()=>{ft.set(n)},remove:t=>{t.preventDefault(),vt.remove(n.id)},$selectedNode:r}}class SceneGraphLeaf extends SvelteComponent{constructor(t){super(),at(this,t,Nt,bt,s,["node"])}}function At(t,e,i){const r=Object.create(t);return r.child=e[i],r}function St(t,e,i){const r=Object.create(t);return r.animation=e[i],r}function Vt(t){var e,i,r,n,o,s=t.showAnimations&&Rt(t);return{c(){e=_("div"),(i=_("span")).textContent="AnimationNodes:",r=N(),s&&s.c(),S(i,"class","svelte-3vna07"),M(i,"dropDown",!t.showAnimations),M(i,"dropUp",t.showAnimations),S(e,"class","category_container svelte-3vna07"),o=A(i,"click",t.toggleAnimations)},m(t,o){v(t,e,o),x(e,i),x(e,r),s&&s.m(e,null),n=!0},p(t,r){t.showAnimations&&(M(i,"dropDown",!r.showAnimations),M(i,"dropUp",r.showAnimations)),r.showAnimations?s?(s.p(t,r),Q(s,1)):((s=Rt(r)).c(),Q(s,1),s.m(e,null)):s&&(q(),Z(s,1,1,()=>{s=null}),K())},i(t){n||(Q(s),n=!0)},o(t){Z(s),n=!1},d(t){t&&y(e),s&&s.d(),o()}}}function Rt(t){for(var e,i,r,n=t.$animationNodes.filter(t.func_1),o=[],s=0;s<n.length;s+=1)o[s]=Mt(St(t,n,s));return{c(){e=_("ul");for(var t=0;t<o.length;t+=1)o[t].c();S(e,"class","children_container svelte-3vna07")},m(t,i){v(t,e,i);for(var n=0;n<o.length;n+=1)o[n].m(e,null);r=!0},p(t,i){if(t.$animationNodes||t.node){n=i.$animationNodes.filter(i.func_1);for(var r=0;r<n.length;r+=1){const s=St(i,n,r);o[r]?o[r].p(t,s):(o[r]=Mt(s),o[r].c(),o[r].m(e,null))}for(;r<o.length;r+=1)o[r].d(1);o.length=n.length}},i(t){r||(G(()=>{i||(i=et(e,_t,{duration:100},!0)),i.run(1)}),r=!0)},o(t){i||(i=et(e,_t,{duration:100},!1)),i.run(0),r=!1},d(t){t&&y(e),w(o,t),t&&i&&i.end()}}}function Mt(t){var e,i,r,n=t.animation.constructor.name+"";return{c(){var t,o,s;e=_("div"),i=b(n),r=N(),t="padding",o="0 0.5em 0 0.5em",e.style.setProperty(t,o,s?"important":"")},m(t,n){v(t,e,n),x(e,i),x(e,r)},p(t,e){(t.$animationNodes||t.node)&&n!==(n=e.animation.constructor.name+"")&&V(i,n)},d(t){t&&y(e)}}}function zt(t){for(var e,i,r,n=t.node.children,o=[],s=0;s<n.length;s+=1)o[s]=Et(At(t,n,s));const a=t=>Z(o[t],1,1,()=>{o[t]=null});return{c(){e=_("ul");for(var t=0;t<o.length;t+=1)o[t].c();S(e,"class","children_container svelte-3vna07")},m(t,i){v(t,e,i);for(var n=0;n<o.length;n+=1)o[n].m(e,null);r=!0},p(t,i){if(t.node||t.GroupNode){n=i.node.children;for(var r=0;r<n.length;r+=1){const s=At(i,n,r);o[r]?(o[r].p(t,s),Q(o[r],1)):(o[r]=Et(s),o[r].c(),Q(o[r],1),o[r].m(e,null))}for(q(),r=n.length;r<o.length;r+=1)a(r);K()}},i(t){if(!r){for(var s=0;s<n.length;s+=1)Q(o[s]);G(()=>{i||(i=et(e,_t,{duration:100},!0)),i.run(1)}),r=!0}},o(t){o=o.filter(Boolean);for(let t=0;t<o.length;t+=1)Z(o[t]);i||(i=et(e,_t,{duration:100},!1)),i.run(0),r=!1},d(t){t&&y(e),w(o,t),t&&i&&i.end()}}}function $t(t){var e,i=new SceneGraphLeaf({props:{node:t.child}});return{c(){i.$$.fragment.c()},m(t,r){nt(i,t,r),e=!0},p(t,e){var r={};t.node&&(r.node=e.child),i.$set(r)},i(t){e||(Q(i.$$.fragment,t),e=!0)},o(t){Z(i.$$.fragment,t),e=!1},d(t){ot(i,t)}}}function Pt(t){var e,i=new SceneGraphNode({props:{node:t.child}});return{c(){i.$$.fragment.c()},m(t,r){nt(i,t,r),e=!0},p(t,e){var r={};t.node&&(r.node=e.child),i.$set(r)},i(t){e||(Q(i.$$.fragment,t),e=!0)},o(t){Z(i.$$.fragment,t),e=!1},d(t){ot(i,t)}}}function Et(t){var e,i,r,n,o=[Pt,$t],s=[];function a(t,e){return e.child instanceof GroupNode?0:1}return e=a(0,t),i=s[e]=o[e](t),{c(){i.c(),r=b("")},m(t,i){s[e].m(t,i),v(t,r,i),n=!0},p(t,n){var c=e;(e=a(0,n))===c?s[e].p(t,n):(q(),Z(s[c],1,1,()=>{s[c]=null}),K(),(i=s[e])||(i=s[e]=o[e](n)).c(),Q(i,1),i.m(r.parentNode,r))},i(t){n||(Q(i),n=!0)},o(t){Z(i),n=!1},d(t){s[e].d(t),t&&y(r)}}}function Tt(t){var e,i,r,n,o,s,a,c=-1!==t.$animationNodes.map(Ct).indexOf(t.node),l=new SceneGraphLeaf({props:{node:t.node}}),h=c&&Vt(t),d=t.showChildren&&zt(t);return{c(){l.$$.fragment.c(),e=N(),h&&h.c(),i=N(),r=_("div"),(n=_("span")).textContent="ChildNodes:",o=N(),d&&d.c(),S(n,"class","svelte-3vna07"),M(n,"dropDown",!t.showChildren),M(n,"dropUp",t.showChildren),S(r,"class","category_container svelte-3vna07"),a=A(n,"click",t.toggleChildren)},m(t,a){nt(l,t,a),v(t,e,a),h&&h.m(t,a),v(t,i,a),v(t,r,a),x(r,n),x(r,o),d&&d.m(r,null),s=!0},p(t,e){var o={};t.node&&(o.node=e.node),l.$set(o),(t.$animationNodes||t.node)&&(c=-1!==e.$animationNodes.map(Ct).indexOf(e.node)),c?h?(h.p(t,e),Q(h,1)):((h=Vt(e)).c(),Q(h,1),h.m(i.parentNode,i)):h&&(q(),Z(h,1,1,()=>{h=null}),K()),t.showChildren&&(M(n,"dropDown",!e.showChildren),M(n,"dropUp",e.showChildren)),e.showChildren?d?(d.p(t,e),Q(d,1)):((d=zt(e)).c(),Q(d,1),d.m(r,null)):d&&(q(),Z(d,1,1,()=>{d=null}),K())},i(t){s||(Q(l.$$.fragment,t),Q(h),Q(d),s=!0)},o(t){Z(l.$$.fragment,t),Z(h),Z(d),s=!1},d(t){ot(l,t),t&&y(e),h&&h.d(t),t&&(y(i),y(r)),d&&d.d(),a()}}}function Ct(t){return t.groupNode}function Ft(t,e,i){let r;l(t,yt,t=>{r=t,i("$animationNodes",r)});let{node:n}=e,o=!0,s=!0;return t.$set=t=>{"node"in t&&i("node",n=t.node)},{node:n,showChildren:o,showAnimations:s,toggleChildren:()=>{i("showChildren",o=!o)},toggleAnimations:()=>{i("showAnimations",s=!s)},$animationNodes:r,func_1:function(t){return t.groupNode===n}}}class SceneGraphNode extends SvelteComponent{constructor(t){super(),at(this,t,Ft,Tt,s,["node"])}}function kt(t){var e,i,r,n,o,s,a=new SceneGraphNode({props:{node:t.$sceneGraph}});return{c(){e=_("div"),(i=_("h2")).textContent="Scene Graph",r=N(),n=_("hr"),o=N(),a.$$.fragment.c(),S(e,"class","scenegraph_container svelte-ov6hnk")},m(t,c){v(t,e,c),x(e,i),x(e,r),x(e,n),x(e,o),nt(a,e,null),s=!0},p(t,e){var i={};t.$sceneGraph&&(i.node=e.$sceneGraph),a.$set(i)},i(t){s||(Q(a.$$.fragment,t),s=!0)},o(t){Z(a.$$.fragment,t),s=!1},d(t){t&&y(e),ot(a)}}}function Bt(t,e,i){let r;return l(t,vt,t=>{r=t,i("$sceneGraph",r)}),{$sceneGraph:r}}class SceneGraph extends SvelteComponent{constructor(t){super(),at(this,t,Bt,kt,s,[])}}function Ut(e){var i,r,o,s,a,c,l,h,d;return{c(){i=_("div"),r=_("label"),o=b(e.name),s=N(),a=_("input"),c=N(),l=_("div"),h=b(e.value),S(r,"for","slider"),S(r,"class","svelte-pb5rkk"),S(a,"type","range"),S(a,"name","slider"),S(a,"min",e.min),S(a,"max",e.max),S(a,"step",e.step),S(a,"class","svelte-pb5rkk"),S(l,"class","value_container svelte-pb5rkk"),S(i,"class","input_group svelte-pb5rkk"),d=[A(a,"change",e.input_change_input_handler),A(a,"input",e.input_change_input_handler)]},m(t,n){v(t,i,n),x(i,r),x(r,o),x(i,s),x(i,a),R(a,e.value),x(i,c),x(i,l),x(l,h)},p(t,e){t.name&&V(o,e.name),t.value&&R(a,e.value),t.min&&S(a,"min",e.min),t.max&&S(a,"max",e.max),t.step&&S(a,"step",e.step),t.value&&V(h,e.value)},i:t,o:t,d(t){t&&y(i),n(d)}}}function Lt(t,e,i){let{value:r,name:n,min:o,max:s,step:a}=e;return t.$set=t=>{"value"in t&&i("value",r=t.value),"name"in t&&i("name",n=t.name),"min"in t&&i("min",o=t.min),"max"in t&&i("max",s=t.max),"step"in t&&i("step",a=t.step)},{value:r,name:n,min:o,max:s,step:a,input_change_input_handler:function(){r=function(t){return""===t?void 0:+t}(this.value),i("value",r)}}}class Slider extends SvelteComponent{constructor(t){super(),at(this,t,Lt,Ut,s,["value","name","min","max","step"])}}function Dt(t){var e,i,r,n,o,s,a,c,l,h,d,u,g;function p(e){t.slider0_value_binding.call(null,e),s=!0,Y(()=>s=!1)}let m={name:"Ambient",min:"0",max:"1",step:"0.01"};void 0!==t.$phongConfiguration.ambient&&(m.value=t.$phongConfiguration.ambient);var f=new Slider({props:m});function w(e){t.slider1_value_binding.call(null,e),c=!0,Y(()=>c=!1)}B.push(()=>rt(f,"value",p));let b={name:"Diffuse",min:"0",max:"1",step:"0.01"};void 0!==t.$phongConfiguration.diffuse&&(b.value=t.$phongConfiguration.diffuse);var A=new Slider({props:b});function V(e){t.slider2_value_binding.call(null,e),h=!0,Y(()=>h=!1)}B.push(()=>rt(A,"value",w));let R={name:"Specular",min:"0",max:"1",step:"0.01"};void 0!==t.$phongConfiguration.specular&&(R.value=t.$phongConfiguration.specular);var M=new Slider({props:R});function z(e){t.slider3_value_binding.call(null,e),u=!0,Y(()=>u=!1)}B.push(()=>rt(M,"value",V));let $={name:"Shininess",min:"0.1",max:"100",step:"0.1"};void 0!==t.$phongConfiguration.shininess&&($.value=t.$phongConfiguration.shininess);var P=new Slider({props:$});return B.push(()=>rt(P,"value",z)),{c(){e=_("div"),(i=_("h2")).textContent="Phong Parameters",r=N(),n=_("hr"),o=N(),f.$$.fragment.c(),a=N(),A.$$.fragment.c(),l=N(),M.$$.fragment.c(),d=N(),P.$$.fragment.c(),S(e,"class","phong_container svelte-1uaflby")},m(t,s){v(t,e,s),x(e,i),x(e,r),x(e,n),x(e,o),nt(f,e,null),x(e,a),nt(A,e,null),x(e,l),nt(M,e,null),x(e,d),nt(P,e,null),g=!0},p(t,e){var i={};!s&&t.$phongConfiguration&&(i.value=e.$phongConfiguration.ambient),f.$set(i);var r={};!c&&t.$phongConfiguration&&(r.value=e.$phongConfiguration.diffuse),A.$set(r);var n={};!h&&t.$phongConfiguration&&(n.value=e.$phongConfiguration.specular),M.$set(n);var o={};!u&&t.$phongConfiguration&&(o.value=e.$phongConfiguration.shininess),P.$set(o)},i(t){g||(Q(f.$$.fragment,t),Q(A.$$.fragment,t),Q(M.$$.fragment,t),Q(P.$$.fragment,t),g=!0)},o(t){Z(f.$$.fragment,t),Z(A.$$.fragment,t),Z(M.$$.fragment,t),Z(P.$$.fragment,t),g=!1},d(t){t&&y(e),ot(f),ot(A),ot(M),ot(P)}}}function Ot(t,e,i){let r;return l(t,gt,t=>{r=t,i("$phongConfiguration",r)}),{$phongConfiguration:r,slider0_value_binding:function(t){r.ambient=t,gt.set(r)},slider1_value_binding:function(t){r.diffuse=t,gt.set(r)},slider2_value_binding:function(t){r.specular=t,gt.set(r)},slider3_value_binding:function(t){r.shininess=t,gt.set(r)}}}class PhongConfigurator extends SvelteComponent{constructor(t){super(),at(this,t,Ot,Dt,s,[])}}class Rasterizable{constructor(){this.loaded=!0}calcNormals(){const t=(t,e,i)=>{const r=t.sub(e);return i.sub(e).cross(r).normalised()};this.normals=[];for(let e=0;e<this.vertices.length;){const i=t(new Vector(this.vertices[e++],this.vertices[e++],this.vertices[e++]),new Vector(this.vertices[e++],this.vertices[e++],this.vertices[e++]),new Vector(this.vertices[e++],this.vertices[e++],this.vertices[e++]));this.normals.push(i.x,i.y,i.z),this.normals.push(i.x,i.y,i.z),this.normals.push(i.x,i.y,i.z)}}fillBuffers(){const t=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.vertices),this.gl.STATIC_DRAW),this.vertexBuffer=t;const e=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(this.indices),this.gl.STATIC_DRAW),this.indexBuffer=e;const i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.colors),this.gl.STATIC_DRAW),this.colourBuffer=i;const r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.normals),this.gl.STATIC_DRAW),this.normalBuffer=r}render(t){if(this.loaded){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);const e=t.getAttributeLocation("a_position");this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colourBuffer);const i=t.getAttributeLocation("a_colour");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,4,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.normalBuffer);const r=t.getAttributeLocation("a_normal");this.gl.enableVertexAttribArray(r),this.gl.vertexAttribPointer(r,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.drawElements(this.gl.TRIANGLES,this.indices.length,this.gl.UNSIGNED_INT,0),this.gl.disableVertexAttribArray(e),this.gl.disableVertexAttribArray(i),this.gl.disableVertexAttribArray(r)}}}class RasterSphere extends Rasterizable{constructor(t,e,i,r,n){super(),this.gl=t,this.vertices=[],this.indices=[],this.normals=[];for(let t=0;t<50;t++)for(let r=0;r<50;r++){let n=t*Math.PI*2/50-1,o=r*Math.PI*2/50,s=i*Math.sin(n)*Math.cos(o)+e.x,a=i*Math.sin(n)*Math.sin(o)+e.y,c=i*Math.cos(n)+e.z;this.vertices.push(s),this.vertices.push(a),this.vertices.push(c);let l=new Vector(s,a,c).sub(e).normalised();this.normals.push(l.x),this.normals.push(l.y),this.normals.push(l.z)}for(let t=0;t<49;t++)for(let e=0;e<50;e++)this.indices.push(50*t+e),this.indices.push(50*t+(e+1)%50),this.indices.push(50*(t+1)+e),this.indices.push(50*t+(e+1)%50),this.indices.push(50*(t+1)+(e+1)%50),this.indices.push(50*(t+1)+e);this.colors=[];for(let t=0;t<this.vertices.length/3;t++)n&&t%2==0?(this.colors.push(n.r),this.colors.push(n.g),this.colors.push(n.b),this.colors.push(n.a)):(this.colors.push(r.r),this.colors.push(r.g),this.colors.push(r.b),this.colors.push(r.a));this.fillBuffers()}}class TextureRasterizable{render(t){if(this.loaded){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);const e=t.getAttributeLocation("a_position");this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texCoords);const i=t.getAttributeLocation("a_texCoord");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.normalBuffer);const r=t.getAttributeLocation("a_normal");this.gl.enableVertexAttribArray(r),this.gl.vertexAttribPointer(r,3,this.gl.FLOAT,!1,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texBuffer),t.getUniformInt("sampler").set(0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.normalMapBuffer),t.getUniformInt("normalSampler").set(1),this.gl.drawArrays(this.gl.TRIANGLES,0,this.elements),this.gl.disableVertexAttribArray(e),this.gl.disableVertexAttribArray(i),this.gl.disableVertexAttribArray(r)}}}const It=t=>{const e=t.split("\n"),i=[],r=[],n=[];return e.forEach(t=>{const e=t.split(/\s/).filter(t=>t.length>0);if(e.length>0)switch(e[0]){case"v":i.push(new Vector(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])));break;case"vn":r.push(new Vector(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])));break;case"f":for(let t=1;t<4;t++)if(e[t].includes("/")){const i=e[t].split("/"),r=parseInt(i[0])-1,o=0==i[2].length?0:parseInt(i[2])-1;n.push({v:r,n:o})}else n.push({v:parseInt(e[t])-1,n:0})}}),{vertices:i,normals:r,indices:n}};class Visitor{constructor(t){this.gl=t,this.matrixStack=[Matrix.identity()],this.matrixStack.top=function(){return this[this.length-1]},this.inverseMatrixStack=[Matrix.identity()],this.inverseMatrixStack.top=function(){return this[this.length-1]},this.shouldRender=!1,this.camera={}}render(t){this.gl.clearColor(0,0,0,.5),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.lightPositions=[],this.shouldRender=!1,this.lightSearch=!1,t.accept(this),this.setupCamera(),this.lightSearch=!0,t.accept(this),this.lightSearch=!1,this.shouldRender=!0,t.accept(this)}setupCamera(){this.lookat=Matrix.lookat(this.camera.eye,this.camera.center,this.camera.up).mul(this.viewMat),this.perspective=Matrix.perspective(this.camera.fovy,this.camera.aspect,this.camera.near,this.camera.far)}visitGroupNode(t){this.matrixStack.push(this.matrixStack.top().mul(t.matrix)),this.inverseMatrixStack.push(t.matrix.invert().mul(this.inverseMatrixStack.top())),t.children.forEach(t=>{t.accept(this)}),this.matrixStack.pop(),this.inverseMatrixStack.pop()}visitCameraNode(t){this.shouldRender||this.lightSearch||(this.camera=t,this.cameraModelMat=this.matrixStack.top(),this.cameraWorld=this.matrixStack.top().mul(t.eye),this.viewMat=this.inverseMatrixStack.top())}visitLightNode(t){this.lightSearch&&this.lightPositions.push(this.lookat.mul(this.matrixStack.top()).mul(new Vector(0,0,0,1)))}}class Shader{constructor(t,e,i){this.vertexShaderSource=e,this.fragmentShaderSource=i,this.gl=t}async load(){let t=this.gl;const e=this.getShader(t,this.vertexShaderSource,t.VERTEX_SHADER),i=this.getShader(t,this.fragmentShaderSource,t.FRAGMENT_SHADER);return Promise.all([e,i]).then(e=>{this.shaderProgram=t.createProgram(),t.attachShader(this.shaderProgram,e[0]),t.attachShader(this.shaderProgram,e[1]),t.linkProgram(this.shaderProgram),t.getProgramParameter(this.shaderProgram,t.LINK_STATUS)||alert("Unable to initialize the shader program: "+t.getProgramInfoLog(this.shaderProgram))})}use(){this.gl.useProgram(this.shaderProgram)}getAttributeLocation(t){const e=this.gl.getAttribLocation(this.shaderProgram,t);return-1!=e&&this.gl.enableVertexAttribArray(e),e}getShader(t,e,i){const r=t.createShader(i);return t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(r)),null)}getUniformMatrix(t){return new UniformMatrix(this.gl,this.gl.getUniformLocation(this.shaderProgram,t))}getUniformVec4(t){return new UniformVec4(this.gl,this.gl.getUniformLocation(this.shaderProgram,t))}getUniformVec3(t){return new UniformVec3(this.gl,this.gl.getUniformLocation(this.shaderProgram,t))}getUniformFloat(t){return new UniformFloat(this.gl,this.gl.getUniformLocation(this.shaderProgram,t))}getUniformInt(t){return new UniformInt(this.gl,this.gl.getUniformLocation(this.shaderProgram,t))}trySet(t,e,i){const r=t(e);r&&r.set(i)}}class UniformMatrix{constructor(t,e){this.gl=t,this.position=e}set(t){this.gl.uniformMatrix4fv(this.position,!1,t.data)}}class UniformVec3{constructor(t,e){this.gl=t,this.position=e}set(t){this.gl.uniform3f(this.position,t.x,t.y,t.z)}}class UniformVec4{constructor(t,e){this.gl=t,this.position=e}set(t){this.gl.uniform4f(this.position,t.x,t.y,t.z,t.w)}}class UniformFloat{constructor(t,e){this.gl=t,this.position=e}set(t){this.gl.uniform1f(this.position,t)}}class UniformInt{constructor(t,e){this.gl=t,this.position=e}set(t){this.gl.uniform1i(this.position,t)}}class RasterVisitor extends Visitor{constructor(t,e,i){super(t),this.shader=e,this.textureShader=i}visit(t){if(this.shouldRender){const e=t.rasterObject instanceof TextureRasterizable?this.textureShader:this.shader;e.use(),gt.loadIntoShader(e),e.trySet(e.getUniformMatrix.bind(e),"M",this.matrixStack.top()),e.trySet(e.getUniformMatrix.bind(e),"V",this.lookat),e.trySet(e.getUniformMatrix.bind(e),"P",this.perspective),e.trySet(e.getUniformMatrix.bind(e),"N",this.lookat.mul(this.matrixStack.top())),this.lightPositions.forEach((t,i)=>{e.trySet(e.getUniformVec3.bind(e),"lightPositions["+i+"]",new Vector(t.x,t.y,t.z))}),e.trySet(e.getUniformInt.bind(e),"lights",this.lightPositions.length),t.rasterObject.render(e)}}}class RasterSetupVisitor{constructor(t){this.gl=t}setup(t){this.gl.clearColor(1,1,1,1),this.gl.clearDepth(1),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.accept(this)}visit(t){t.rasterObject=new Gt[t.constructor.name](this.gl,...Object.values(t).slice(1))}visitGroupNode(t){for(let e of t.children)e.accept(this)}visitCameraNode(t){}visitLightNode(t){}}const Gt={SphereNode:RasterSphere,AABoxNode:class RasterBox extends Rasterizable{constructor(t,e,i,r){super(),this.gl=t;const n=e,o=i;this.vertices=[n.x,n.y,o.z,o.x,n.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,n.x,o.y,o.z,n.x,n.y,o.z,o.x,n.y,n.z,n.x,n.y,n.z,n.x,o.y,n.z,n.x,o.y,n.z,o.x,o.y,n.z,o.x,n.y,n.z,o.x,n.y,o.z,o.x,n.y,n.z,o.x,o.y,n.z,o.x,o.y,n.z,o.x,o.y,o.z,o.x,n.y,o.z,n.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,n.z,o.x,o.y,n.z,n.x,o.y,n.z,n.x,o.y,o.z,n.x,n.y,n.z,n.x,n.y,o.z,n.x,o.y,o.z,n.x,o.y,o.z,n.x,o.y,n.z,n.x,n.y,n.z,n.x,n.y,n.z,o.x,n.y,n.z,o.x,n.y,o.z,o.x,n.y,o.z,n.x,n.y,o.z,n.x,n.y,n.z],this.indices=[...Array(36).keys()],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],this.colors=[];for(let t=0;t<this.vertices.length/3;t++)this.colors.push(r.r),this.colors.push(r.g),this.colors.push(r.b),this.colors.push(r.a);this.fillBuffers()}},TextureBoxNode:class RasterTextureBox extends TextureRasterizable{constructor(t,e,i,r,n){super(),this.loaded=!1,this.gl=t;const o=e,s=i;this.vertices=[o.x,o.y,s.z,s.x,o.y,s.z,s.x,s.y,s.z,s.x,s.y,s.z,o.x,s.y,s.z,o.x,o.y,s.z,s.x,o.y,o.z,o.x,o.y,o.z,o.x,s.y,o.z,o.x,s.y,o.z,s.x,s.y,o.z,s.x,o.y,o.z,s.x,o.y,s.z,s.x,o.y,o.z,s.x,s.y,o.z,s.x,s.y,o.z,s.x,s.y,s.z,s.x,o.y,s.z,o.x,s.y,s.z,s.x,s.y,s.z,s.x,s.y,o.z,s.x,s.y,o.z,o.x,s.y,o.z,o.x,s.y,s.z,o.x,o.y,o.z,o.x,o.y,s.z,o.x,s.y,s.z,o.x,s.y,s.z,o.x,s.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,s.x,o.y,o.z,s.x,o.y,s.z,s.x,o.y,s.z,o.x,o.y,s.z,o.x,o.y,o.z];const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),this.vertexBuffer=a,this.elements=this.vertices.length/3,new Promise((e,i)=>{let n=t.createTexture(),o=new Image;o.onload=()=>{t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),e()},o.src=r,this.texBuffer=n}).then(()=>{let e=t.createTexture(),i=new Image;i.onload=()=>{t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)},i.src=n,this.normalMapBuffer=e}).then(()=>this.loaded=!0);let c=this.gl.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0]),t.STATIC_DRAW),this.texCoords=c,this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0];const l=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.normals),this.gl.STATIC_DRAW),this.normalBuffer=l}},PyramidNode:class RasterPyramid extends Rasterizable{constructor(t,e,i,r,n){super(),this.gl=t;const o=e,s=i,a=new Vector((o.x+s.x)/2,o.y+r,(o.z+s.z)/2,1);this.vertices=[o.x,o.y,s.z,s.x,o.y,s.z,a.x,a.y,a.z,s.x,o.y,s.z,s.x,o.y,o.z,a.x,a.y,a.z,o.x,o.y,o.z,o.x,o.y,s.z,a.x,a.y,a.z,s.x,o.y,o.z,o.x,o.y,o.z,a.x,a.y,a.z,s.x,o.y,o.z,s.x,o.y,s.z,o.x,o.y,s.z,o.x,o.y,s.z,o.x,o.y,o.z,s.x,o.y,o.z],this.indices=[...Array(this.vertices.length/3).keys()],this.calcNormals(),this.colors=[];for(let t=0;t<this.vertices.length/3;t++)this.colors.push(n.r),this.colors.push(n.g),this.colors.push(n.b),this.colors.push(n.a);this.fillBuffers()}},MeshNode:class RasterMesh extends Rasterizable{constructor(t,e,i){super(),this.loaded=!1,this.gl=t,this.vertices=[],this.indices=[],this.normals=[],this.colors=[],fetch(e).then(t=>t.text()).then(t=>{const e=It(t);e.indices.forEach(t=>{(isNaN(t.v)||isNaN(t.n))&&(hasNaNs=!0);const i=e.vertices[t.v];if(i&&this.vertices.push(i.x,i.y,i.z),e.normals.length>0){const i=e.normals[t.n];this.normals.push(i.x,i.y,i.z)}}),0===e.normals.length&&this.calcNormals();for(let t=0;t<this.vertices.length/3;t++)this.colors.push(i.r),this.colors.push(i.g),this.colors.push(i.b),this.colors.push(i.a);this.indices=[...Array(this.vertices.length/3).keys()],this.fillBuffers()}).then(()=>this.loaded=!0)}}};class RayVisitor extends Visitor{constructor(t,e){super(t),this.shader=e}setupCamera(){super.setupCamera(),this.fillBuffers()}render(t){this.sphereCenters=[],this.sphereRadii=[],this.sphereColors=[],super.render(t);const e=this.shader;e.use(),e.trySet(e.getUniformVec3.bind(e),"camera",this.cameraWorld),e.trySet(e.getUniformMatrix.bind(e),"iMVP",this.perspective.mul(this.lookat).invert()),gt.loadIntoShader(this.shader),this.sphereCenters.forEach((t,i)=>{e.trySet(e.getUniformVec3.bind(e),"sphereCenters["+i+"]",new Vector(t.x,t.y,t.z))}),this.sphereColors.forEach((t,i)=>{e.trySet(e.getUniformVec4.bind(e),"sphereColors["+i+"]",new Vector(t.x,t.y,t.z,1))}),this.sphereRadii.forEach((t,i)=>{e.trySet(e.getUniformFloat.bind(e),"sphereRadii["+i+"]",t)}),e.trySet(e.getUniformInt.bind(e),"spheres",this.sphereCenters.length),this.lightPositions.forEach((t,i)=>{e.trySet(e.getUniformVec3.bind(e),"lightPositions["+i+"]",new Vector(t.x,t.y,t.z))}),e.trySet(e.getUniformInt.bind(e),"lights",this.lightPositions.length),this.draw()}fillBuffers(){this.screenBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.screenBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),this.gl.STATIC_DRAW)}draw(){gt.loadIntoShader(this.shader),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.screenBuffer);const t=this.shader.getAttributeLocation("a_vertexPosition");this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),this.gl.disableVertexAttribArray(t)}visit(t){this.shouldRender&&t instanceof SphereNode&&(this.sphereCenters.push(this.matrixStack.top().mul(new Vector(0,0,0,1))),this.sphereRadii.push(t.radius),this.sphereColors.push(t.color))}}class Sphere{constructor(t,e){this.center=t,this.radius=e}intersect(t){let e=t.origin,i=t.direction,r=this.center.sub(e).dot(i);if(r>0){let t=e.add(i.mul(r)),n=this.center.sub(t).length;if(n<this.radius){let t=Math.sqrt(this.radius*this.radius-n*n),o=r-t,s=r+t,a=Math.min(o,s);return new Intersection(a,e.add(i.mul(a)),e.add(i.mul(a)).sub(this.center).normalised())}}return null}}class CollisionVisitor extends Visitor{constructor(t,e){super(t),this.shader=e,this.renderActive=!1,this.intersectActive=!1}toggleRender(){this.renderActive=!this.renderActive}toggleIntersect(){this.intersectActive=!this.intersectActive}render(t){this.minIntersection=new Intersection,this.intersectedNode={},vt.remove("debug"),this.lightSearch=!1,this.shouldRender=!1,this.intersectionSearch=!1,t.accept(this),this.setupCamera(),this.intersectionSearch=!0,t.accept(this),this.intersectActive&&ft.set(this.intersectedNode),this.intersectionSearch=!1,this.shouldRender=!0,t.accept(this),c(xt)&&mt.set(c(ft))}draw(t){const e=this.shader;e.use(),gt.loadIntoShader(e),e.trySet(e.getUniformMatrix.bind(e),"M",this.matrixStack.top()),e.trySet(e.getUniformMatrix.bind(e),"V",this.lookat),e.trySet(e.getUniformMatrix.bind(e),"P",this.perspective),t==c(ft)?e.trySet(e.getUniformVec4.bind(e),"color",new Vector(1,1,0,.5)):t==c(mt)?e.trySet(e.getUniformVec4.bind(e),"color",new Vector(1,.64,0,.5)):e.trySet(e.getUniformVec4.bind(e),"color",new Vector(1,0,0,.5)),t.rasterBoundingSphere.render(e)}getIntersection(t){const e=this.perspective.mul(this.lookat).invert();let i=e.mul(new Vector(c(dt).x,c(dt).y,-1,1));i=i.div(i.w);let r=e.mul(new Vector(c(dt).x,c(dt).y,1,1));r=r.div(r.w);const n=new Sphere(this.matrixStack.top().mul(t.boundingSphere.center),t.boundingSphere.radius).intersect({origin:i,direction:r.sub(i).normalised()});n&&n.closerThan(this.minIntersection)&&(this.minIntersection=n,this.intersectedNode=t)}visit(t){t.rasterBoundingSphere&&(this.renderActive&&this.shouldRender&&this.draw(t),this.intersectActive&&this.intersectionSearch&&this.getIntersection(t))}visitCameraNode(t){this.shouldRender||this.intersectionSearch||super.visitCameraNode(t)}}class CollisionSetupVisitor{constructor(t){this.gl=t}setup(t){t.accept(this)}visit(t){if(!t.id.includes("noColl")){const e=()=>{if(0===t.rasterObject.vertices.length)setTimeout(e,1e3);else{const e=t.rasterObject.vertices,i=[];for(let t=0;t<e.length;t+=3)i.push(new Vector(e[t],e[t+1],e[t+2],1));const{ritterCenter:r,ritterRadius:n}=Xt(i);t.boundingSphere=new SphereNode("",r,n,new Vector(0,0,0,0)),t.rasterBoundingSphere=new RasterSphere(this.gl,r,n,new Vector(1,0,0,.5))}};e()}}visitGroupNode(t){for(let e of t.children)e.accept(this)}visitCameraNode(t){}visitLightNode(t){}}const Yt=t=>(e,i)=>{const r=t.sub(i).length;return r>e.currMin?{currMin:r,currentMax:i}:e},Xt=t=>{const e=t[0];let i=t.reduce(Yt(e),{currMin:0,currentMax:{}}).currentMax,r=t.reduce(Yt(i),{currMin:0,currentMax:{}}).currentMax,n=i.sub(r).length/2,o=i.add(r.sub(i).mul(.5));let s=0;for(;t.filter(t=>t.sub(o).length>n+.005).length>0&&s++<10;){const e=t.filter(t=>t.sub(o).length>n+.005)[0],s=o.add(e.sub(o).normalised().mul(-n));n=e.sub(s).length/2,o=e.add(s.sub(e).mul(.5)),i=e,r=s}return{ritterCenter:o,ritterRadius:n}};class AnimationNode{constructor(t){this.active=!0;const e=[];for(e.push.apply(e,c(vt).children),e.push(c(vt));e.length>0;){const i=e.pop();if(i.id==t){this.groupNode=i;break}i instanceof GroupNode&&e.push.apply(e,i.children)}}toggleActive(){this.active=!this.active}}class RotationNode extends AnimationNode{constructor(t,e,i){super(t),this.angle=i,this.axis=e,this.origin=this.groupNode.matrix.transpose().transpose(),this.currentAngle=0}simulate(t){this.active&&(this.currentAngle+=this.angle*t/1e3%360,this.groupNode.matrix=Matrix.rotation(this.axis,this.currentAngle).mul(this.origin))}toJSON(){return{type:this.constructor.name,groupNodeId:this.groupNode.id,axis:this.axis,currentAngle:this.currentAngle,origin:this.origin,angle:this.angle}}static fromJSON(t){const e=new Vector(t.axis._x,t.axis._y,t.axis._z,t.axis._w),i=new RotationNode(t.groupNodeId,e,t.angle);return i.currentAngle=t.currentAngle,i.origin.data=t.origin.data,i}}class BouncingNode extends AnimationNode{constructor(t,e,i,r){super(t),this.distance=i,this.speed=r,this.axis=e,this.value=0,this.translation=Matrix.identity(),this.origin=this.groupNode.matrix.transpose().transpose()}simulate(t){this.active&&(this.value+=t/(1e3/this.speed),this.groupNode.matrix=this.translation.mul(Matrix.translation(this.axis.mul(Math.sin(this.value)*this.distance))).mul(this.origin))}toJSON(){return{type:this.constructor.name,groupNodeId:this.groupNode.id,axis:this.axis,distance:this.distance,speed:this.speed,translation:this.translation,value:this.value,origin:this.origin}}static fromJSON(t){const e=new Vector(t.axis._x,t.axis._y,t.axis._z,t.axis._w),i=new BouncingNode(t.groupNodeId,e,t.distance,t.speed);return i.translation.data=t.translation.data,i.value=t.value,i.origin.data=t.origin.data,i}}class ManualRotationNode extends AnimationNode{constructor(t,e){super(t),this.angle=90,this.axis=e,this.origin=this.groupNode.matrix.transpose().transpose(),this.currentAngle=0}simulate(t){this.active&&c(mt)===this.groupNode&&(c(pt).get("ArrowRight")&&(this.currentAngle+=-this.angle*t/1e3%360),c(pt).get("ArrowLeft")&&(this.currentAngle+=this.angle*t/1e3%360),this.groupNode.matrix=Matrix.rotation(this.axis,this.currentAngle).mul(this.origin))}toJSON(){return{type:this.constructor.name,groupNodeId:this.groupNode.id,axis:this.axis,currentAngle:this.currentAngle,origin:this.origin}}static fromJSON(t){const e=new Vector(t.axis._x,t.axis._y,t.axis._z,t.axis._w),i=new ManualRotationNode(t.groupNodeId,e);return i.currentAngle=t.currentAngle,i.origin.data=t.origin.data,i}}class DriverNode extends AnimationNode{constructor(t,e,i,r){super(t),this.speed=r,this.firstAxis=e,this.secondAxis=i,this.origin=this.groupNode.matrix.transpose().transpose(),this.translationMatrix=Matrix.identity(),this.active=!0}simulate(t){this.active&&c(mt)===this.groupNode&&(c(pt).get("ArrowRight")&&(this.translationMatrix=Matrix.translation(this.firstAxis.mul(t*this.speed/1e3)).mul(this.translationMatrix)),c(pt).get("ArrowLeft")&&(this.translationMatrix=Matrix.translation(this.firstAxis.mul(-t*this.speed/1e3)).mul(this.translationMatrix)),c(pt).get("ArrowUp")&&(this.translationMatrix=Matrix.translation(this.secondAxis.mul(t*this.speed/1e3)).mul(this.translationMatrix)),c(pt).get("ArrowDown")&&(this.translationMatrix=Matrix.translation(this.secondAxis.mul(-t*this.speed/1e3)).mul(this.translationMatrix)),this.groupNode.matrix=this.translationMatrix.mul(this.origin))}toJSON(){return{type:this.constructor.name,groupNodeId:this.groupNode.id,translationMatrix:this.translationMatrix,origin:this.origin,firstAxis:this.firstAxis,secondAxis:this.secondAxis,speed:this.speed}}static fromJSON(t){const e=new Vector(t.firstAxis._x,t.firstAxis._y,t.firstAxis._z,t.firstAxis._w),i=new Vector(t.secondAxis._x,t.secondAxis._y,t.secondAxis._z,t.secondAxis._w),r=new DriverNode(t.groupNodeId,e,i,t.speed);return r.translationMatrix.data=t.translationMatrix.data,r.origin.data=t.origin.data,r}}class FreeFlightNode extends AnimationNode{constructor(t,e){super(t),this.mouseSensitivity=e,this.origin=this.groupNode.matrix.transpose().transpose(),this.currentX=0,this.currentY=0,this.translationMatrix=Matrix.identity(),this.active=!1}simulate(t){this.active&&(c(pt).get("a")&&(this.translationMatrix=Matrix.translation(this.groupNode.matrix.getLeftVector().mul(-10*t/1e3)).mul(this.translationMatrix)),c(pt).get("d")&&(this.translationMatrix=Matrix.translation(this.groupNode.matrix.getLeftVector().mul(10*t/1e3)).mul(this.translationMatrix)),c(pt).get("w")&&(this.translationMatrix=Matrix.translation(this.groupNode.matrix.getForwardVector().mul(-10*t/1e3)).mul(this.translationMatrix)),c(pt).get("s")&&(this.translationMatrix=Matrix.translation(this.groupNode.matrix.getForwardVector().mul(10*t/1e3)).mul(this.translationMatrix)),c(pt).get("q")&&(this.translationMatrix=Matrix.translation(this.groupNode.matrix.getUpVector().mul(10*t/1e3)).mul(this.translationMatrix)),c(pt).get("e")&&(this.translationMatrix=Matrix.translation(this.groupNode.matrix.getUpVector().mul(-10*t/1e3)).mul(this.translationMatrix)),this.currentY+=-c(ut).y*t/100*this.mouseSensitivity,this.currentX+=-c(ut).x*t/100*this.mouseSensitivity,this.groupNode.matrix=this.translationMatrix.mul(Matrix.rotation(new Vector(0,1,0),this.currentX).mul(Matrix.rotation(new Vector(1,0,0),this.currentY))).mul(this.origin),ut.reset())}toJSON(){return{type:this.constructor.name,groupNodeId:this.groupNode.id,mouseSensitivity:this.mouseSensitivity,currentX:this.currentX,currentY:this.currentY,translationMatrix:this.translationMatrix,origin:this.origin}}static fromJSON(t){const e=new FreeFlightNode(t.groupNodeId,t.mouseSensitivity);return e.currentX=t.currentX,e.currentY=t.currentY,e.translationMatrix=new Matrix([]),e.translationMatrix.data=t.translationMatrix.data,e.origin.data=t.origin.data,e}}const jt={RotationNode:RotationNode,BouncingNode:BouncingNode,ManualRotationNode:ManualRotationNode,FreeFlightNode:FreeFlightNode,DriverNode:DriverNode},{window:Jt}=it;function Ht(t){var e,i,r,o,s,a,c,l,h,d,u,g,p,m,f,w,R,M,z,$,P,E,T,C,F,k,B,U,L,D,O,I,G,Y,X,j=new SceneGraph({}),J=new PhongConfigurator({});return{c(){e=_("div"),i=_("div"),(r=_("div")).innerHTML='<img style="margin-right: 1em;" id="logo-img" alt="HCI Logo" src="hci-logo.png" width="70px" height="70px"> <div><a href="/" class="svelte-1kopvts"><h1>ICG CS Master Project</h1></a> <em style="padding-left: 1em; font-size: 1em">Long Bui</em></div>',o=N(),s=_("div"),(a=_("button")).textContent="Toggle Bounding Spheres",c=N(),(l=_("button")).textContent="Toggle Animation",h=N(),(d=_("button")).textContent="Toggle Renderer",u=N(),(g=_("a")).textContent="Save Scene",p=N(),m=_("button"),f=b("Load Scene\n        "),w=_("input"),R=N(),M=_("div"),z=_("div"),j.$$.fragment.c(),$=N(),P=_("div"),J.$$.fragment.c(),E=N(),T=_("div"),C=_("canvas"),F=N(),k=_("div"),B=_("div"),U=b("FPS: "),L=b(t.fps),D=N(),O=_("div"),I=b("Average: "),G=b(t.averageFps),S(r,"class","logo svelte-1kopvts"),S(a,"type","button"),S(a,"class","btn btn-primary"),S(l,"type","button"),S(l,"class","btn btn-primary"),S(d,"id","renderer_toggle"),S(d,"type","button"),S(d,"class","btn btn-primary"),S(g,"id","save_button"),S(g,"role","button"),S(g,"class","btn btn-primary"),S(g,"download","scenegraph.json"),S(g,"href","/"),S(w,"id","file-uploader"),S(w,"type","file"),S(w,"accept","application/json"),S(w,"class","svelte-1kopvts"),S(m,"id","load_button"),S(m,"type","button"),S(m,"class","btn btn-primary"),S(s,"class","header__button-group"),S(i,"id","header"),S(i,"class","svelte-1kopvts"),S(z,"class","sidebar__scenegraph svelte-1kopvts"),S(P,"class","sidebar__configurator svelte-1kopvts"),S(M,"id","sidebar"),S(M,"class","svelte-1kopvts"),S(C,"class","main_content__canvas svelte-1kopvts"),S(C,"width","1920"),S(C,"height","1080"),S(B,"class","svelte-1kopvts"),S(O,"class","svelte-1kopvts"),S(k,"class","main_content__overlay svelte-1kopvts"),S(T,"class","main_content svelte-1kopvts"),S(e,"class","main-container svelte-1kopvts"),X=[A(Jt,"keydown",t.handleKeyDown),A(Jt,"keyup",t.handleKeyUp),A(a,"click",t.handleBoundToggle),A(l,"click",t.handleStop),A(d,"click",t.toggleRenderer),A(g,"click",t.handleDownload),A(w,"change",t.handleUpload),A(m,"click",t.click_handler),A(C,"contextmenu",t.startFreeFlight),A(C,"mousemove",t.handleMouseMove),A(C,"mouseenter",t.toggleIntersectSearch),A(C,"mouseleave",t.toggleIntersectSearch),A(C,"mousedown",t.handleMouseDown),A(C,"mouseup",t.handleMouseUp)]},m(n,y){v(n,e,y),x(e,i),x(i,r),x(i,o),x(i,s),x(s,a),x(s,c),x(s,l),x(s,h),x(s,d),x(s,u),x(s,g),t.a_1_binding(g),x(s,p),x(s,m),x(m,f),x(m,w),t.input_binding(w),x(e,R),x(e,M),x(M,z),nt(j,z,null),x(M,$),x(M,P),nt(J,P,null),x(e,E),x(e,T),x(T,C),t.canvas_1_binding(C),x(T,F),x(T,k),x(k,B),x(B,U),x(B,L),x(k,D),x(k,O),x(O,I),x(O,G),Y=!0},p(t,e){Y&&!t.fps||V(L,e.fps),Y&&!t.averageFps||V(G,e.averageFps)},i(t){Y||(Q(j.$$.fragment,t),Q(J.$$.fragment,t),Y=!0)},o(t){Z(j.$$.fragment,t),Z(J.$$.fragment,t),Y=!1},d(i){i&&y(e),t.a_1_binding(null),t.input_binding(null),ot(j),ot(J),t.canvas_1_binding(null),n(X)}}}function Wt(t,e,i){let r,n,o,s,a,h,d,u,g,p,m,f,x,v,y,w;l(t,vt,t=>{r=t,i("$sceneGraph",r)}),l(t,yt,t=>{n=t,i("$animationNodes",n)}),l(t,pt,t=>{o=t,i("$keysPressed",o)}),l(t,mt,t=>{s=t,i("$selectedNode",s)}),l(t,xt,t=>{a=t,i("$mouseClicked",a)});let _=0,b=0,N=0,A=0,S=1e3;F(()=>{const t=g.getContext("webgl",{premultipliedAlpha:!1});t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.getExtension("OES_element_index_uint"),(t=>{vt.set(new GroupNode("root",Matrix.identity()));const e=new GroupNode("baseTranslation",Matrix.translation(new Vector(0,0,-8))),i=new GroupNode("desktopBase",Matrix.identity());e.add(i),i.add(new TextureBoxNode("towerBase",new Vector(-2,-2,-2,1),new Vector(2,2,2,1),"hci-logo.png","wood.jpg"));const r=new GroupNode("clockHandRoot",Matrix.translation(new Vector(0,0,2)));r.add(new PyramidNode("clockHand",new Vector(-.25,-.5,-.25,1),new Vector(.25,-.5,.25,1),2,new Vector(0,.6,0,1)));const n=new GroupNode("clockFixNode",Matrix.translation(new Vector(0,0,.25,1)));n.add(new SphereNode("clockFix",new Vector(0,0,0,1),.1,new Vector(.5,.2,.4,1)));const o=new GroupNode("clockHandTipGroup",Matrix.translation(new Vector(0,2,0,1)).mul(Matrix.scaling(new Vector(.5,.5,.5))));o.add(new MeshNode("clockMonkey","monkey.obj",new Vector(.3,.2,0,1))),n.add(o),r.add(n),i.add(r);const s=new GroupNode("teapotGroup",Matrix.translation(new Vector(0,2.05,0,1)).mul(Matrix.scaling(new Vector(.4,.4,.4))));s.add(new MeshNode("teapot","teapot.obj",new Vector(1,.8,0,1))),i.add(s);const a=new GroupNode("carpetGroup",Matrix.translation(new Vector(0,-2,0)));a.add(new TextureBoxNode("carpet-noColl",new Vector(-20,0,-20,1),new Vector(20,.01,20),"carpet.jpg","pillow.jpg")),e.add(a);const c=new GroupNode("houseGroup",Matrix.translation(new Vector(0,-2.1,0)));c.add(new TextureBoxNode("houseNode-noColl",new Vector(-20,0,-20,1),new Vector(20,20,20),"shack.jpg","wood.jpg")),e.add(c);const l=new GroupNode("sphereRoot",Matrix.translation(new Vector(0,8,0))),h=new GroupNode("sphere1Group",Matrix.translation(new Vector(-10,0,-3)));h.add(new SphereNode("sphere1",new Vector(0,0,0,1),1,new Vector(.7,.7,.7,1),new Vector(0,0,0,.5))),l.add(h);const d=new GroupNode("sphere2Group",Matrix.translation(new Vector(10,-2,-5)));d.add(new SphereNode("sphere2",new Vector(0,0,0,1),1.5,new Vector(.3,0,0,1))),l.add(d);const u=new GroupNode("sphere3Group",Matrix.translation(new Vector(-4,-4,4)));u.add(new SphereNode("sphere3",new Vector(0,0,0,1),1.5,new Vector(0,0,.4,1),new Vector(1,1,1,1))),l.add(u);const g=new GroupNode("flyingCow",Matrix.translation(new Vector(0,1,-5)).mul(Matrix.scaling(new Vector(.5,.5,.5))));g.add(new MeshNode("cow","cow.obj",new Vector(0,.4,.4,1))),l.add(g);const p=new GroupNode("flyingBunny",Matrix.translation(new Vector(0,2,5)).mul(Matrix.scaling(new Vector(5,5,5))));p.add(new MeshNode("bunny","bunnyHR.obj",new Vector(.6,0,.4,1))),l.add(p),i.add(l);const m=new GroupNode("camerHolder",Matrix.translation(new Vector(0,2,10,1))),f=new GroupNode("cameraNode",Matrix.identity());f.add(new CameraNode("camera",new Vector(0,0,1,1),new Vector(0,0,-1,1),new Vector(0,1,0,0),75,t.width/t.height,.1,100)),m.add(f);const x=new GroupNode("lightNode",Matrix.translation(new Vector(0,5,0,1)));x.add(new LightNode("centerLight",new Vector(1,0,0,1)));const v=new GroupNode("sunNode",Matrix.translation(new Vector(20,0,0,1)));v.add(new LightNode("sun",new Vector(1,1,0,1))),vt.add(m),vt.add(e),vt.add(x),vt.add(v),yt.add(new DriverNode(l.id,new Vector(1,0,0),new Vector(0,0,-1),5)),yt.add(new RotationNode(i.id,new Vector(0,1,0),45)),yt.add(new BouncingNode(o.id,new Vector(0,1,0),1,2)),yt.add(new BouncingNode(x.id,new Vector(1,0,0),.25,2)),yt.add(new RotationNode(r.id,new Vector(0,0,1),90)),yt.add(new RotationNode(v.id,new Vector(0,1,0),90)),yt.add(new RotationNode(p.id,new Vector(0,1,0),90)),yt.add(new RotationNode(p.id,new Vector(0,0,1),90)),yt.add(new RotationNode(g.id,new Vector(0,1,0),90)),yt.add(new RotationNode(g.id,new Vector(0,0,1),90)),yt.add(new FreeFlightNode(f.id,.5))})(g),y=new RayVisitor(t,new Shader(t,"attribute vec2 a_vertexPosition;varying vec3 rayOrigin;varying vec3 rayDirection;uniform mat4 iMVP;void main(void){vec2 vertex=a_vertexPosition*2.0-vec2(1.0);vec4 farPlane=iMVP*vec4(vertex,1.0,1.0);farPlane/=farPlane.w;vec4 nearPlane=iMVP*vec4(vertex,-1.0,1.0);nearPlane/=nearPlane.w;rayDirection=(farPlane.xyz-nearPlane.xyz);rayOrigin=nearPlane.xyz;gl_Position=vec4(vertex,0.0,1.0);}","precision mediump float;varying vec3 rayDirection;varying vec3 rayOrigin;uniform vec3 light0;struct Ray{vec3 origin;vec3 direction;};struct Hit{vec3 position;vec3 normal;float t;vec4 color;};struct Sphere{vec3 center;float radius;vec4 color;};const float EPS=0.0001;const float START_T=100000.0;const int MAX_DEPTH=3;Ray initRay(){Ray r;r.origin=rayOrigin;r.direction=normalize(rayDirection);return r;}float intersectRaySphere(in Ray ray,in Sphere sphere){vec3 rayOrigin=ray.origin;vec3 rayDir=ray.direction;float t=dot((sphere.center-rayOrigin),rayDir);vec3 ortho=rayOrigin+(rayDir*t);float y=length(sphere.center-ortho);if(y<sphere.radius){float x=sqrt(sphere.radius*sphere.radius-y*y);float t1=t-x;float t2=t+x;float firstHitDistance=min(t1,t2);return firstHitDistance;}return-1.;}uniform vec3 lightPositions[8];const int maxLights=8;uniform int lights;Sphere sphereObjects[7];const int maxSpheres=64;uniform vec3 camera;uniform vec3 sphereCenters[64];uniform vec4 sphereColors[64];uniform float sphereRadii[64];uniform int spheres;uniform float kA;uniform float kD;uniform float kS;uniform float shininess;void initScene(){for(int i=0;i<maxSpheres;i++){if(i<spheres){sphereObjects[i].center=sphereCenters[i];sphereObjects[i].radius=sphereRadii[i];sphereObjects[i].color=sphereColors[i];}}}bool traceScene(in Ray ray,inout Hit hit){hit.t=START_T;float t=START_T;if(t>=0.0&&t<=hit.t){hit.t=t;hit.position=ray.origin+ray.direction*t;hit.normal=vec3(0,1,0);}for(int i=0;i<7;++i){t=intersectRaySphere(ray,sphereObjects[i]);if(t>=0.0&&t<=hit.t){vec3 pos=ray.origin+ray.direction*t;vec3 N=normalize(pos-sphereObjects[i].center);hit.t=t;hit.normal=N;hit.color=sphereObjects[i].color;hit.position=pos;}}return hit.t<START_T;}vec4 diffuse(vec3 lightPos,vec3 hit,vec3 normal,vec4 color){float lambertian=max(dot(normalize(lightPos-hit),normal),.0);return color*kD*lambertian;}vec4 specular(vec3 lightPos,vec3 hit,vec3 normal,vec4 color){vec3 l=normalize(lightPos-hit);vec3 r=reflect(-l,normal);vec3 v=normalize(camera-hit);return color*kS*pow(max(dot(r,v),0.0),shininess);}void main(){Ray ray=initRay();initScene();vec4 color=vec4(ray.direction,1.0);Hit hit;if(traceScene(ray,hit)){color=kA*hit.color;for(int i=0;i<maxLights;i++){if(i<lights){color+=(diffuse(lightPositions[i],hit.position,hit.normal,hit.color)+specular(lightPositions[i],hit.position,hit.normal,hit.color));}}}gl_FragColor=color;}")),m=new RasterVisitor(t,new Shader(t,"attribute vec3 a_position;attribute vec3 a_normal;attribute vec4 a_colour;uniform mat4 M;uniform mat4 V;uniform mat4 P;uniform mat4 N;varying vec4 v_color;varying vec3 v_pos;varying vec3 v_normal;void main(){mat4 modelView=V*M;vec4 vert_pos=modelView*vec4(a_position,1.);gl_Position=P*vert_pos;v_normal=normalize(vec3(N*vec4(a_normal,.0)));v_color=a_colour;v_pos=vec3(vert_pos.xyz/vert_pos.w);}","precision mediump float;uniform vec3 lightPositions[8];const int maxLights=8;uniform int lights;varying vec4 v_color;varying vec3 v_normal;varying vec3 v_pos;uniform float kA;uniform float kD;uniform float kS;uniform float shininess;vec4 ambient(){return v_color*kA;}vec4 diffuse(vec3 lightPos){float lambertian=max(dot(normalize(lightPos-v_pos),v_normal),.0);return v_color*kD*lambertian;}vec4 specular(vec3 lightPos){vec3 l=normalize(lightPos-v_pos);vec3 r=reflect(-l,v_normal);vec3 v=normalize(-v_pos);return v_color*kS*pow(max(dot(r,v),0.0),shininess);}void main(void){gl_FragColor=ambient();for(int i=0;i<maxLights;i++){if(i<lights){gl_FragColor+=(diffuse(lightPositions[i])+specular(lightPositions[i]));}}gl_FragColor.a=v_color.a;}"),new Shader(t,"attribute vec3 a_position;attribute vec3 a_normal;attribute vec2 a_texCoord;uniform mat4 M;uniform mat4 V;uniform mat4 P;uniform mat4 N;varying vec2 v_texCoord;varying vec3 v_pos;varying vec3 v_normal;void main(){mat4 modelView=V*M;vec4 vert_pos=modelView*vec4(a_position,1.);gl_Position=P*vert_pos;v_texCoord=a_texCoord;v_normal=normalize(vec3(N*vec4(a_normal,.0)));v_pos=vec3(vert_pos.xyz/vert_pos.w);}","precision mediump float;uniform vec3 lightPositions[8];const int maxLights=8;uniform int lights;uniform sampler2D sampler;uniform sampler2D normalSampler;varying vec2 v_texCoord;varying vec3 v_normal;varying vec3 v_pos;uniform float kA;uniform float kD;uniform float kS;uniform float shininess;float ambient(){return kA;}float diffuse(vec3 lightPos,vec3 normal){float lambertian=max(dot(normalize(lightPos-v_pos),normal),.0);return kD*lambertian;}float specular(vec3 lightPos,vec3 normal){vec3 l=normalize(lightPos-v_pos);vec3 r=reflect(-l,normal);vec3 v=normalize(-v_pos);return kS*pow(max(dot(r,v),0.0),shininess);}void main(void){vec4 textureColor=texture2D(sampler,v_texCoord);vec4 normalCoord=2.*(texture2D(normalSampler,v_texCoord))-1.;gl_FragColor=vec4((textureColor*ambient()).xyz,1.0);for(int i=0;i<maxLights;i++){if(i<lights){gl_FragColor+=vec4((textureColor*diffuse(lightPositions[i],normalize(v_normal+normalCoord.xyz))+textureColor*specular(lightPositions[i],normalize(v_normal+normalCoord.xyz))).xyz,1.0);}}gl_FragColor.a=textureColor.a;}")),f=new RasterSetupVisitor(t),x=new CollisionVisitor(t,new Shader(t,"attribute vec3 a_position;attribute vec4 a_colour;attribute vec3 a_normal;uniform mat4 M;uniform mat4 V;uniform mat4 P;void main(){vec3 throwAway=a_normal;throwAway=vec3(0.,0.,0.);vec4 color=a_colour;color=vec4(0.,0.,0.,0.);mat4 modelView=V*M;vec4 vert_pos=modelView*vec4(a_position,1.);gl_Position=P*vert_pos;}","precision mediump float;uniform vec4 color;void main(void){gl_FragColor=color;}")),v=new CollisionSetupVisitor(t),p=m,f.setup(r),v.setup(r);let e=performance.now();const i=t=>{const o=t-e;(t=>{for(let e of n)e.simulate(t)})(o),p.render(r),x.render(r),V(o),e=t,window.requestAnimationFrame(i)};Promise.all([m.shader.load(),m.textureShader.load(),y.shader.load(),x.shader.load()]).then(t=>window.requestAnimationFrame(i))});const V=t=>{_++,b+=t,i("averageFps",w=(_/(b/1e3)).toFixed(2)),A++,b>=S&&(i("fps",N=A),S=b+1e3,A=0)};document.addEventListener("pointerlockchange",t=>{document.pointerLockElement!==g&&document.mozPointerLockElement!==g&&n.filter(t=>t instanceof FreeFlightNode).forEach(t=>t.active=!1)});return{fileInput:h,downloadButton:d,canvas:g,averageFps:w,fps:N,toggleRenderer:()=>{p=p===m?y:m},handleKeyDown:t=>{o.get(t.key)||pt.keydown(t.key)},handleKeyUp:t=>{pt.keyup(t.key)},handleUpload:t=>{const e=t.target.files[0];if(e){const i=new FileReader;i.onload=t=>{let e=JSON.parse(t.target.result),i=e.sceneGraph,o=e.animationNodes;s={},mt.set(s),r=GroupNode.fromJSON(i),vt.set(r),f.setup(r),v.setup(r),n=o.map(t=>jt[t.type].fromJSON(t)),yt.set(n)},i.readAsText(e),t.target.value=""}},handleDownload:t=>{u&&window.URL.revokeObjectURL(u),u=window.URL.createObjectURL(new Blob([JSON.stringify({sceneGraph:r,animationNodes:n})],{type:"application/json"})),d.href=u,i("downloadButton",d)},handleMouseMove:t=>{document.pointerLockElement===g&&(ut.addX(t.movementX),ut.addY(t.movementY));const e=t.clientX,i=t.clientY,r=t.target.getBoundingClientRect();if(r.left<=e&&e<r.right&&r.top<=i&&i<r.bottom){const t=e-r.left,n=r.bottom-i,o=r.bottom-r.top,s=r.right-r.left;dt.setX(2*t/s-1),dt.setY(2*n/o-1)}},toggleIntersectSearch:()=>{x.toggleIntersect()},handleStop:t=>{c(yt).filter(t=>!(t instanceof FreeFlightNode)).forEach(t=>t.toggleActive())},handleBoundToggle:()=>{x.toggleRender()},startFreeFlight:t=>{t.preventDefault(),g.requestPointerLock=g.requestPointerLock||g.mozRequestPointerLock,i("canvas",g),g.requestPointerLock(),n.filter(t=>t instanceof FreeFlightNode).forEach(t=>t.active=!0)},handleMouseDown:t=>{1==t.which&&(a=!0,xt.set(a))},handleMouseUp:t=>{1==t.which&&(a=!1,xt.set(a))},a_1_binding:function(t){B[t?"unshift":"push"](()=>{i("downloadButton",d=t)})},input_binding:function(t){B[t?"unshift":"push"](()=>{i("fileInput",h=t)})},click_handler:function(){h.click()},canvas_1_binding:function(t){B[t?"unshift":"push"](()=>{i("canvas",g=t)})}}}return new class App extends SvelteComponent{constructor(t){super(),at(this,t,Wt,Ht,s,[])}}({target:document.body})}();
//# sourceMappingURL=bundle.js.map
